/* 测试数据*/
//var Data1 = '{"State":1,"Message":"执行成功","DataCount":19,"Data":[{"it":0,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 16:07:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":1,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 16:07:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":2,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 11:58:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":3,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 11:58:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":4,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 11:58:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":5,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 11:58:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":6,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/14 14:29:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"67.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":7,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/14 14:29:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"67.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":8,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/14 14:22:37","RcvTime":null,"Lon":"109.003745","Lat":"30.120334","Speed":"67.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014887","offsetLat":"30.123459","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":9,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/14 14:22:37","RcvTime":null,"Lon":"109.003745","Lat":"30.120334","Speed":"67.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014887","offsetLat":"30.123459","InternalNum":null,"Duration":null,"DurationStatus":null}]}';
//localStorage.setItem('trackData',Data1);
//localStorage.setItem('carNoVal','123456');
/* ------------end--------------*/

var user = JSON.parse(localStorage.getItem("userInfo"));		//获取登录数据
var trackData = JSON.parse(localStorage.getItem('trackData'));		//历史轨迹数据
var Points = [];												//百度历史轨迹经纬度数组
var NoZeroData = [];											//去除速度为0的数据数组
var NoZeroPoints = [];											//去除速度为0的百度经纬度点数组
var thsPointIndex = 0;											//有速度0当前播放点下标
var NoPointIndex = 0;											//无速度0当前播放点下标
var NoZeroItIndex = {};											//无0数据对应的有0数组中的it
var playInterval;												//播放轨迹定时任务标识
var playSpeed = 1000;											//播放速度,初始为1000毫秒
var beginMarker,endMarker,playMarker;							//起始标点,结束标点,播放标签
var status = 0;													//播放状态,0起始,1播放,2暂停,3停止
var playSpeedStatus = 0;										//播放快进或慢放-1慢放,0正常,1跨进
var NoZeroStatus = 1;											//播放状态,1无0速度播放,0有0播放
var switchValue;												//switch的值
var carNoVal = localStorage.getItem('carNoVal');
var Data = trackData.Data;
var totalMile = 0;											//累计里程
var trackPlayChildPage;												//轨迹播放子页面id
var stopData = trackData.StopData;									//停车数据
var stopMarkerArr = [];												//停车点mark数组
var stopMarker = null;												//停车点mark
var infoData = null;												//自定义窗口要显示的数据
var infoBoxWindow = null;											//信息窗口
//	-----------------end---------------------------

//地图及样式初始化
var trackMap;
var geoc;
var webWidth = (document.body.clientWidth - 10) + 'px';
document.getElementById('trackBox').style.width = webWidth;

mui.init({
	swipeBack:false
});
mui.ready(function(){
	$('#carNoVal').html(carNoVal);
	
	geoc = new BMap.Geocoder();	
	trackMap = new BMap.Map('trackMap',{
		minZoom: 5,
		maxZoom: 25,		
	});
	trackMap.centerAndZoom(new BMap.Point(Data[0].offsetLon, Data[0].offsetLat),15);
//	map.setCurrentCity('武汉');
	initDate(Data);
			
	mui('.controlImg').on('tap','#centerControl',function(){
		play();
	});
	mui('.controlImg').on('tap','#leftControl',function(){
		clearInterval(playInterval);
		if(1 === playSpeedStatus){					//快进后慢放
			playSpeed = 1000;	
		}
		if(playSpeed < 1800){
			playSpeedStatus = -1;
			playSpeed += 200;
			var speedValue ='x' + (playSpeed-1000)/200;	
			mui.closePopup();
			mui.toast('慢放:'+speedValue,{
				type: 'div'
			})
		}
		status = 1;	
		$("#centerControl").attr("src","../img/images/stop_03.png");
		playInterval = setInterval(paintTrackLine, playSpeed);
	});
	mui('.controlImg').on('tap','#rightControl',function(){
		clearInterval(playInterval);
		if(-1 == playSpeedStatus){					//慢放后快进
			playSpeed = 1000;
		}
		playSpeedStatus = 1;
		if(playSpeed > 200){
			playSpeed-=200;	
			var speedValue ='x' + (1000-playSpeed)/200;
			mui.closePopup();
			mui.toast('快放:'+speedValue,{
				type: 'div'
			})
		}
		status = 1;	
		$("#centerControl").attr("src","../img/images/stop_03.png");
		playInterval = setInterval(paintTrackLine, playSpeed);
	});
});

//初始化数据
function initDate(Data){
	var count = 0;
	for(var i=0;i<Data.length;i++){
		if(i == 0){ totalMile = 0;}
		if(i > 0 && Data[i].Mileage != 0){
			totalMile += parseFloat(Data[i].Mileage) - parseFloat(Data[i-1].Mileage);			
		}
		Data[i].totalMile = totalMile;
		var point = new BMap.Point(Data[i].offsetLon, Data[i].offsetLat); 
		Points.push(point);
		if(Data[i].Speed != 0){
			NoZeroData.push(Data[i]);
			NoZeroPoints.push(point);
			NoZeroItIndex[Data[i].it] = count;
			count++;
		}		
	}
	addOverlays(Data,Points);
		
	geoc.getLocation(new BMap.Point(Data[0].offsetLon,Data[0].offsetLat), function(rs){
       var addComp = rs.addressComponents;
       var adress = addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber;
       $('#trackAdress').html(adress);
    });
	$('#topTime').html(Data[0].GPSTime);
	$('#trackSpeed').html(parseFloat(Data[0].Speed).toFixed(1)+'km/h');
	$('#trackMile').html('0km');
	$('#trackDirection').html(Data[0].DirectStr);
//	$('#trackOil').html(parseFloat(Data[0].OilNum).toFixed(1)+'L');
	$('#statusDescribe').html(Data[0].StatusDes);
	if(Data[0].OilNum>-1){
		$("#trackOil").html(parseFloat(Data[0].OilNum).toFixed(1)+'L');
	}else{
		$("#trackOil").html('----L');
	}
}

//初始化画轨迹线
function addOverlays(data,Points){  //data和Points数组长度相同
	var leng = data.length - 1;
	var playIcon = null;
	playIcon = directionToImg(data[0].DirectStr,data[0].CarStatus);
	beginMarker = new BMap.Marker(Points[0],{icon:new BMap.Icon("../img/images/trajectory_03.png",new BMap.Size(20,28),{anchor: new BMap.Size(9, 28)})});	
	endMarker = new BMap.Marker(Points[leng],{icon:new BMap.Icon("../img/images/trajectory_09.png",new BMap.Size(20,28),{anchor: new BMap.Size(9, 28)})});
	playMarker = new BMap.Marker(Points[0],{icon:new BMap.Icon(playIcon.img,new BMap.Size(28,28))});

	var polyline = new BMap.Polyline(Points,{strokeColor:"green",strokeWeight:3,strokeOpacity:1,strokeStyle:"solid"});			
		
	trackMap.addOverlay(beginMarker);
	trackMap.addOverlay(endMarker);
	trackMap.addOverlay(playMarker);
	trackMap.addOverlay(polyline);
	trackMap.panTo(Points[0]);
	//设置range的值
	if($(".mui-switch").hasClass("mui-active")){					//无0播放状态,默认
		$("#block-range").prop("max",NoZeroPoints.length);
	}else{
		$("#block-range").prop("max",leng);							//有0播放
	}
	var range = document.getElementById("block-range");
	range.addEventListener("input",function(e){
		dragTrack(parseInt(this.value));
	});
//	console.log(1);
	stopCarMark();	
}


//拖动进度条
function dragTrack(theIndex){
	var maxValue = $('#block-range').prop('max');
	var percentValue = parseFloat(theIndex/maxValue).toFixed(3)*100+'%';
	$('#block-range').css('background','-webkit-linear-gradient(left,#45D2FF '+ percentValue +',#e2e2e2 '+ percentValue+ ')');
	if($(".mui-switch").hasClass("mui-active")){
		NoPointIndex = theIndex;
		if(NoPointIndex >= NoZeroData.length -1){
			NoPointIndex = NoZeroData.length -1;
		}
		dataShow(NoZeroData[NoPointIndex]);
		var playIcon = directionToImg(NoZeroData[NoPointIndex].DirectStr,NoZeroData[NoPointIndex].CarStatus);
		playMarker.setIcon(new BMap.Icon(playIcon.img,new BMap.Size(28,28)));
		playMarker.setPosition(NoZeroPoints[NoPointIndex]);
		//没有播放,直接拖动进度条
		if(status == 0){
			trackMap.addOverlay(playMarker);
			trackMap.panTo(NoZeroPoints[NoPointIndex]);
		}  //block-range		
	}else{
		thsPointIndex = theIndex;
		if(thsPointIndex >= Data.length -1){
			thsPointIndex = Data.length -1;
		}
		dataShow(Data[thsPointIndex]);
		var playIcon = directionToImg(Data[thsPointIndex].DirectStr,Data[thsPointIndex].CarStatus);
		playMarker.setIcon(new BMap.Icon(playIcon.img,new BMap.Size(28,28)));
		playMarker.setPosition(Points[thsPointIndex]);
		//没有播放,直接拖动进度条
		if(status == 0){
			trackMap.addOverlay(playMarker);
			trackMap.panTo(Points[thsPointIndex]);
		}		
	}
}

//播放,暂停
function play(){
	clearInterval(playInterval);
	var leng = Data.length;
	if(leng === 0){
		return;
	}
	trackMap.setZoom(15);
	trackMap.addOverlay(playMarker);
    if (status == 0) {								//第一次点击播放按钮
        status = 1;
        $("#centerControl").attr("src","../img/images/stop_03.png");
        playInterval = setInterval(paintTrackLine, playSpeed);
    }else if(status == 1){							//播放状态,点击后变成播放按钮,暂停播放
    	status = 2;
        $("#centerControl").attr("src","../img/images/play_18.png");
        clearInterval(playInterval);
    }else if(status == 2 ){							//暂停状态,点击后变成暂停按钮,播放轨迹
    	status = 1;
    	$("#centerControl").attr("src","../img/images/stop_03.png");
        playInterval = setInterval(paintTrackLine, playSpeed);
	}
}

//播放轨迹
function paintTrackLine(){
	var leng = Data.length;
	var lengZero = NoZeroData.length;
	thsPointIndex = parseInt(thsPointIndex);
	NoPointIndex = parseInt(NoPointIndex);
	if($(".mui-switch").hasClass("mui-active")){				//播放无0轨迹
		if(!lengZero){											//若速度全为0
			$(".mui-switch").removeClass("mui-active");
			$("#block-range").prop("max",leng);	
			NoZeroStatus =0;
			return;
		}
		if(1 !== NoZeroStatus){									//从有0播放切换到无0播放
			NoZeroStatus = 1;									//状态改变
			var It = Data[thsPointIndex].it;
	//		console.log(It);
			$("#block-range").prop("max",lengZero);			//重置进度条最大值
			if(Data[thsPointIndex].Speed != 0){				//若是有0播放正好播放到有速度的,直接利用it进行切换到无0播放
				NoPointIndex = NoZeroItIndex[It];
			}else{												//若是播放到无速度时切换,无0数据组中没有数据,无法利用it进行匹配,要循环原始数据进行匹配
				var maxNoZeroIt = NoZeroData[lengZero -1].it;	//若有0播放的it比无0播放的最后一个值的it都大,直接停止播放
				if(It >= maxNoZeroIt){
					NoPointIndex=lengZero;
				}else{
					for(var i=0;i<lengZero;i++){				//循环检查it的值,先和最大值进行过比较,此处不用考虑数据越界
						if(It > NoZeroData[i].it && It < NoZeroData[i+1].it){
							NoPointIndex = i;
							break;
						}
					}
				}
			}
		}
		if(lengZero > NoPointIndex){
			var thsData = NoZeroData[NoPointIndex];
			trackMap.panTo(NoZeroPoints[NoPointIndex]);
			$("#block-range").val(NoPointIndex+1);				//进度条设置
			var maxValue = $('#block-range').prop('max');
			var percentValue = parseFloat((NoPointIndex+1)/maxValue).toFixed(3)*100+'%';
			//console.log(percentValue);console.log(NoPointIndex);
			//console.log(JSON.stringify(thsData));
			$('#block-range').css('background','-webkit-linear-gradient(left,#45D2FF '+ percentValue +',#e2e2e2 '+ percentValue+ ')');
			var playIcon = directionToImg(thsData.DirectStr,thsData.CarStatus); //console.log(JSON.stringify(playIcon));
			playMarker.setIcon(new BMap.Icon(playIcon.img,new BMap.Size(28,28)));		//图标设置											
			playMarker.setPosition(NoZeroPoints[NoPointIndex]);	//坐标设置
			dataShow(thsData);									//信息设置
			NoPointIndex++;
		}else{
			NoPointIndex = lengZero - 1;						//让索引处于最大值
			status = 0;											//停止状态
			$("#centerControl").attr("src","../img/images/play_18.png");  
			clearInterval(playInterval);
	//		$('#block-range').css('background','-webkit-linear-gradient(left,#45D2FF 100%,#e2e2e2 100%)');
			mui.toast("播放结束!");
		}
	}else{														//播放有0数据
		if(0 !== NoZeroStatus){									//从无0播放切换到有0播放,检查状态	
			NoZeroStatus = 0;									//状态改变
			if(NoZeroData.length){								//若NoZeroData有数据
				thsPointIndex = NoZeroData[NoPointIndex].it;	//根据两组都有的数据库排序it进行数据切换,NoZeroData的it不连续,但和原始数据对应
			}else{												//若NoZeroData没有数据
				thsPointIndex = 0 ; 
			}
			$("#block-range").prop("max",leng);					//重置进度条最大值
		}
		if(leng > thsPointIndex){						//播放有0轨迹
			var thsData = Data[thsPointIndex];
			trackMap.panTo(Points[thsPointIndex]);
			$("#block-range").val(thsPointIndex+1);				//进度条设置
			var maxValue = $('#block-range').prop('max');
			var percentValue = parseFloat((thsPointIndex+1)/maxValue).toFixed(3)*100+'%';
		//	console.log(percentValue);console.log(thsPointIndex);
			$('#block-range').css('background','-webkit-linear-gradient(left,#45D2FF '+ percentValue +',#e2e2e2 '+ percentValue+ ')');
			var playIcon = directionToImg(thsData.DirectStr,thsData.CarStatus);// console.log(playIcon);
			playMarker.setIcon(new BMap.Icon(playIcon.img,new BMap.Size(28,28)));		//图标设置			
			playMarker.setPosition(Points[thsPointIndex]);		//坐标设置
			dataShow(thsData);									//信息设置
			thsPointIndex++;
		}else{
			thsPointIndex = leng - 1;					//让索引处于最大值
			status = 0;									//停止状态
			$("#centerControl").attr("src","../img/images/play_18.png");    
			clearInterval(playInterval);
	//		$('#block-range').css('background','-webkit-linear-gradient(left,#45D2FF 100%,#e2e2e2 100%)');
			mui.toast("播放结束!");
		}
	}
}

//数据展示
function dataShow(param){
	var adress = null;
	var pt = new BMap.Point(param.offsetLon,param.offsetLat);
//	geoc.getLocation(pt, function(rs){
//     var addComp = rs.addressComponents;
//     adress = addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber;
//     $('#trackAdress').html(adress);
//  });
	getRightLocation(param.offsetLon,param.offsetLat,'trackAdress');
	
	$("#topTime").html(param.GPSTime ? param.GPSTime : new Date().toLocaleDateString());
	$("#trackSpeed").html(parseFloat(param.Speed).toFixed(1)+'km/h');
	$("#trackDirection").html(param.DirectStr);	
	$("#statusDescribe").html(param.StatusDes);
	$("#trackMile").html(parseFloat(param.totalMile).toFixed(1)+'km');
	if(param.OilNum>-1){
		$("#trackOil").html(parseFloat(param.OilNum).toFixed(1)+'L');
	}else{
		$("#trackOil").html('----L');
	}
}

 //根据方向不同指定不同图标type为状态:正常,离线,报警,可不传
function directionToImg(direction,CarStatus) {
	var CarStatus = 5;
	if(CarStatus == 0){  		//未上线
		CarStatus = 'offline';
	}else if(CarStatus == 1){    //离线
		CarStatus = 'offline';
	}else if(CarStatus == 2){	//在线
		CarStatus = 'online';
	}else if(CarStatus == 3){	//停车
		CarStatus = 'park';
	}else if(CarStatus == 4){	//报警				
		CarStatus = 'warn';
	}else{
		CarStatus = 'track';
	}
	
	if(direction == '东北'){
		return {img:"../img/direction/"+ CarStatus + "_01.png",name:"东北"};
	}else if (direction == '正东') {
        return {img:"../img/direction/"+ CarStatus +"_02.png",name:"正东"};
    }else if (direction == '东南') {
        return {img:"../img/direction/"+ CarStatus +"_03.png",name:"东南"};
    }else if (direction == '正南') {
        return {img:"../img/direction/"+ CarStatus +"_04.png",name:"正南"};
    }else if (direction == '西南') {
        return {img:"../img/direction/"+ CarStatus +"_05.png",name:"西南"};
    }else if (direction == '正西') {
        return {img:"../img/direction/"+ CarStatus +"_06.png",name:"正西"};
    }else if (direction == '西北') {
        return {img:"../img/direction/"+ CarStatus +"_07.png",name:"西北"};
    }else if(direction == '正北') {
        return {img:"../img/direction/"+ CarStatus +"_08.png",name:"正北"};
    }else{
    	return {img:"../img/direction/"+ CarStatus + "_01.png",name:"东北"};
    }
}

function getRightLocation(Lon,Lat,id){	//纬度，经度，id
	$.ajax({
        url: 'http://api.map.baidu.com/geocoder/v2/?ak=YpPYDb9u47Zvs6AElUqiTKtyZkpeEw20' + '&callback=renderReverse&location=' + Lat + ',' + Lon + '&output=json&pois=1&coordtype=bd09ll',
        type: 'post',
        dataType: 'jsonp',
        async: true,
        success: function (json) {
            if (json != null || json != undefined) {
                var address = json.result.formatted_address + ',' + json.result.sematic_description;
            //    console.log(address);console.log(Lat+','+Lon);
                $('#'+id).html(address);            
            }
        }
    });
}

//显示停车点
function stopCarMark(){	
//	console.log(JSON.stringify(stopData));
	if(stopData.length == 0){ console.log('a'); return; }
//	alert(JSON.stringify(stopData));
	stopData.forEach(function(item){
		if(!item.offsetLon || !item.offsetLat){ return }
		var stopPoint = new BMap.Point(item.offsetLon,item.offsetLat);
		stopMarker = new BMap.Marker(stopPoint,{icon:new BMap.Icon("../img/images/the-p_03.png",new BMap.Size(14,14),{anchor: new BMap.Size(7, 7)})});
		trackMap.addOverlay(stopMarker);
		stopMarker.addEventListener('click',showInfoWindow);
//		stopMarkerArr.push(stopMarker);
	})
}

//显示窗口
function showInfoWindow(e){ 
	var markObj = e.target
	var pos = e.target.point;
//	var j = null;

	if(infoBoxWindow){
		infoBoxWindow.close();
	}

	for(var i=0; i<stopData.length; i++){
		if(stopData[i].offsetLon == pos.lng && stopData[i].offsetLat == pos.lat){ // console.log(11);
			infoData = stopData[i];
//			j = i;
			break;
		}
	}	
	infoData.StartTime =  infoData.StartTime.replace("T"," ");
	infoData.EndTime = infoData.EndTime.replace("T"," ");
	html =  '<div class="infoBoxContent">' +
			'<ul>' +
			'<li><span>开始时间:</span><span> ' + infoData.StartTime + '</span></li>' +
			'<li><span>结束时间:</span><span> ' + infoData.EndTime + '</span></li>' +
			'<li><span>停车时长:</span><span> ' + infoData.StopTimeLong + '分钟</span></li>' +			
			'<li><span>地址:</span><span id="stopAdress"> ' + infoData.Address + '</span></li>' +
			'</ul>' +			
			'<div id="whiteAngle"></div>' +
			'</div>';
	
	infoBoxWindow = new BMapLib.InfoBox(trackMap, html, {
		boxStyle: {
			background: "transparent",
			width: "260px",
			borderRadius: '8px'
		},
		boxClass: "infoBox",
		closeIconUrl: '../img/images/center_17.png',
		closeIconMargin: "5px",
		enableAutoPan: true,
		align: INFOBOX_AT_TOP
	});
//	infoBoxWindow.open(stopMarkerArr[j]);
	infoBoxWindow.open(markObj);
	
	setTimeout(function(){
		$('.infoBox > img:first-child').on("touchend", function() {
			infoBoxWindow.close();		
		})
	},200)
	
	if(infoData.Address == ''){
		getRightLocation(infoData.offsetLon, infoData.offsetLat, "stopAdress");			
	}
}
//国标转百度坐标
//function getCoordinates(Data){
//	for(var i=0;i<Data.length;i++){
//		var point = new plus.maps.Point(Data[i].Lon, Data[i].Lat);
//		plus.maps.Map.convertCoordinates(point,{coordType:"wgs84"},function(event){
//			var point = event.coord;  // 转换后的坐标值
//			var coordType = event.coordType;	// 转换后的坐标系类型
//			console.log(JSON.stringify(point));
//	//	    getReverseGeocode(point.longitude, point.latitude, myPoint); 
//		},function(e){
//			alert("Failed:"+JSON.stringify(e));
//		});
//	}		
//}
