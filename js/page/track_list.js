/* 测试数据*/
//	var Data1 = '{"State":1,"Message":"执行成功","DataCount":19,"Data":[{"it":0,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 16:07:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":1,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 16:07:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":2,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 11:58:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":3,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 11:58:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":4,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 11:58:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":5,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/15 11:58:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"2.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":6,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/14 14:29:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"67.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":7,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/14 14:29:37","RcvTime":null,"Lon":"109.003745","Lat":"29.120334","Speed":"67.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014802","offsetLat":"29.123131","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":8,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/14 14:22:37","RcvTime":null,"Lon":"109.003745","Lat":"30.120334","Speed":"67.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014887","offsetLat":"30.123459","InternalNum":null,"Duration":null,"DurationStatus":null},{"it":9,"ObjectID":"10940","ObjectCode":"20150525092423248484","VehicleNum":"15027387324","SIM":null,"SIM2":null,"AllDayContacter":null,"AllDayTel":null,"MDTType":null,"Color":null,"HoldName":"GPS调度系统","GPSTime":"2018/6/14 14:22:37","RcvTime":null,"Lon":"109.003745","Lat":"30.120334","Speed":"67.00","StatusDes":"中心查询返回的定位,启动,运营,空载,油路正常,电路断开,车门加锁,紧急报警,疲劳驾驶报警,","Direct":"30","GpsFlag":null,"OilNum":"0.000","Mileage":"12500.00000","Address":"","DataCount":0,"CarStatus":0,"CarStatusStr":"未上线","DirectStr":"东北","offsetLon":"109.014887","offsetLat":"30.123459","InternalNum":null,"Duration":null,"DurationStatus":null}]}';
//	localStorage.setItem('trackData',Data1);
//	localStorage.setItem('carNoVal','123456');
	/* ------------end--------------*/


mui.init({
	swipeBack:false
});
mui.ready(function(){
	var deceleration = mui.os.ios?0.003:0.0009;
	mui('.mui-scroll-wrapper').scroll({
		bounce: false,
		indicators: false, //是否显示滚动条
		deceleration:deceleration
	});				
})

var jy_Vehicle_his = localStorage.getItem('jy_Vehicle_his');
var userInfo = JSON.parse(localStorage.getItem('userInfo'));
var searchDiv =document.querySelector('.searchDiv');
//var ss,z;             //标记车牌号是否改变,避免重复请求同一辆车；
var startTime,endTime;
var picker = null;		//时间对象
var scrollDivUl = null;  //车辆列表ul

if(jy_Vehicle_his){
	mui('.search_tit')[0].value = jy_Vehicle_his;
	mui('.mui-title')[0].innerHTML = jy_Vehicle_his;
}

mui('.search_header_div').on('input','.search_tit',function(){
	var searchParam = mui('.search_tit')[0].value;
//	console.log(searchParam);
	if(searchParam == ''){
		searchDiv.style.display = 'none';
		return;
	}else{
		var xmlhttp = new XMLHttpRequest(); 
			searchDiv.style.display = 'block';
		           
        xmlhttp.open("POST", WebApi+"/api/Vehicle/GetVehicleSearchList?userID="+userInfo.Data.UserID +"&searchString="+escape(searchParam)+"&key="+appLoginKey, true);
    //  xmlhttp.open("POST", "http://192.168.1.119:8808/api/Vehicle/GetVehicleSearchList?userID=4420&searchString=鄂ALE&key=E73D905A94D65EE5CBB149EDC24DDC89", true);
        xmlhttp.send();  // 要发送的参数，要转化为json字符串发送给后端，后端就会接受到json对象
        xmlhttp.onreadystatechange = function(){
            if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
    //            console.log(xmlhttp.responseText);
                var result = JSON.parse(xmlhttp.responseText);
                	result = result.Data;
                var searchUl = document.querySelector(".searchDiv>ul");
                	searchUl.innerHTML = '';
                if(!result){ return; }
                for(var i=0;i<result.length;i++){
                	var li = document.createElement('li');
                		li.setAttribute('class','searchLi');
                		li.dataset.carid = result[i].ObjectID;
                		li.innerText = result[i].VehicleNum;
                	searchUl.appendChild(li);	
                }
            }
        }			
		mui('.searchDiv').on('tap','.searchLi',function(){
			mui('.search_tit')[0].value = this.innerText;
			mui('.search_tit')[0].dataset.toTime = this.dataset.carid
			searchDiv.style.display = 'none';			
		});
	}
})

mui('.head_three').on('tap','.my-control-item',function(){
		var self = this;
		var j = self.dataset.index;	// console.log(j);
		var searchParam = mui('.search_tit')[0].value;
		mui('.my-control-item').each(function(i,item){		
			item.classList.remove('my-active');
		})			
		mui('.mui-scroll-wrapper').each(function(i,item){
			item.classList.remove('my-active');
		});
		self.classList.add('my-active');
		mui('.mui-scroll-wrapper')[j].classList.add('my-active');
		
//		if(ss == searchParam && z == j){ 
//			return 
//		}else{
//			ss = searchParam;
//			z = j;
//			console.log(1);
//			getCarList();
//		}
		if(j == 0){
			getCarList(j)
		}else if(j == 1){
			getCarList(j);
		}else if(j == 2){
//			userPicker.show(function(items){
//				console.log(items);				
//				j= items[0].value;	
//				getCarList(j);
//			});							
			document.getElementById("dataDiv").style.display= 'block';
			mui('#beginTime')[0].innerHTML = new Date(new Date().getTime()-86400000).DatePattern('yyyy-MM-dd HH:mm');
			mui('#endTime')[0].innerHTML = new Date().DatePattern('yyyy-MM-dd HH:mm');
	}
})
mui(document).on('tap','.dataSpan',function(e){
	var target = e.target;
	picker = new mui.DtPicker();
	if(target.id === "beginTime"){
		picker.show(function(rs){
			mui('#beginTime')[0].innerHTML = rs.text;
		});
	}else if(target.id === "endTime"){
		picker.show(function(rs){
			mui('#endTime')[0].innerHTML = rs.text;
		});
	}
});

mui(document).on('tap','.dataBtn',function(e){
	var target = e.target;
	if(target.id === "yesBtn"){
		var start = new Date(mui('#beginTime')[0].innerHTML).getTime();
		var end = new Date(mui('#endTime')[0].innerHTML).getTime();	
		if(end - start > 259200000){
			mui.toast('查询时间间隔不能超过三天');
			return;
		}else if(start > end){
			mui.toast('开始时间不能大于结束时间');
			return;
		}
		getCarList(2);
		document.getElementById("dataDiv").style.display= 'none';
	}else if(target.id === "noBtn"){
		document.getElementById("dataDiv").style.display= 'none';
	}
})

//获取车辆列表
function getCarList(index){
	if(mui('.search_tit')[0].value == ''){
		mui.toast('请输入车牌');
		return
	}	
	getTime(index);
	var objectID;
	var carNo = mui('.search_tit')[0].value;
	var userid = userInfo.Data.UserID;  //console.log(userid);
	if(mui('.search_tit')[0].dataset.toTime){
		 objectID = mui('.search_tit')[0].dataset.toTime;
	}else{
		 objectID = localStorage.getItem('currentObjectID');
	}		
	var xmlhttp = new XMLHttpRequest(); 					           
      xmlhttp.open("POST", WebApi+"/api/vehicle/GetObjectTrajectory?userid="+userid+"&objectID="+objectID+"&pageSize=0&pageIndex=0&locus=2&startTime="+startTime+"&endTime="+endTime+"&key="+appLoginKey+"&carNo="+escape(carNo), true);
      console.log(WebApi+"/api/vehicle/GetObjectTrajectory?userid="+userid+"&objectID="+objectID+"&pageSize=0&pageIndex=0&locus=2&startTime="+startTime+"&endTime="+endTime+"&key="+appLoginKey+"&carNo="+escape(carNo));
    //  xmlhttp.open("POST", "http://192.168.1.119:8808/api/vehicle/GetObjectTrajectory?userid=4420&objectID=10940&pageSize=0&pageIndex=0&locus=3&startTime=2018-06-14HQ01-00-00&endTime=2018-06-15HQ20-40-00&key=E73D905A94D65EE5CBB149EDC24DDC89", true);
      xmlhttp.send();  // 要发送的参数，要转化为json字符串发送给后端，后端就会接受到json对象
      xmlhttp.onreadystatechange = function(){
          if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
  //            console.log(xmlhttp.responseText);
              var result = JSON.parse(xmlhttp.responseText);
              showCarList(index,result.Data);
              localStorage.setItem('trackData',JSON.stringify(result));
              localStorage.setItem('carNoVal',mui('.search_tit')[0].value);         
          }    
      }        
}

//获取时间
function getTime(index){
	var toTime =new Date().getTime(); //console.log(toTime);
	if(index == 0){  //今天
	    toTime = new Date(toTime).DatePattern('yyyy-MM-dd');	 // console.log(toTime); 
	    startTime = toTime+'HQ'+'00:00';
		endTime = new Date().DatePattern('yyyy-MM-dd')+'HQ'+'23:59';
	}else if(index == 1){  //昨天
		toTime = new Date(toTime-86400000).DatePattern('yyyy-MM-dd'); //console.log(toTime);
		startTime = toTime+'HQ'+'00:00';
		endTime = new Date().DatePattern('yyyy-MM-dd')+'HQ'+'23:59';
	}else{   //自定义，前几天index则为几；
	//	toTime = new Date(toTime-86400000*index).DatePattern('yyyy-MM-dd'); console.log(toTime);
		startTime = mui('#beginTime')[0].innerHTML.replace(' ','HQ');	console.log(startTime);
		endTime = mui('#endTime')[0].innerHTML.replace(' ','HQ');	console.log(endTime);
	}
	
}
//显示车辆列表
function showCarList(index,data){
	var scrollDiv = mui('.mui-scroll-wrapper')[index];
	scrollDivUl = scrollDiv.querySelector('.mui-table-view');
	scrollDivUl.innerHTML = '';
	if(!data){ mui.toast('没有历史轨迹!'); return false; }			
	sessionStorage.setItem('trackData',JSON.stringify(data));	   //存储单车轨迹数据	
	var leng = data.length;
	var toStart = data[0].GPSTime;             //开始时间
	var toEnd = data[leng-1].GPSTime;		   //结束时间
	var startPoint = 0;					   //起点
	var endPoint = 1;							   //终点	   
	var scrollLi;
	var totalMile = 0;						//总里程	
	
	for(var i=0;i<data.length;i++){
		if(i > 0 && data[i].Mileage != 0){
			totalMile += data[i].Mileage - data[i-1].Mileage;
		}
	}
	
	scrollLi = '<li class="mui-table-view-cell car-content-list">'
				 + '<div class="car-title">'+ mui(".search_tit")[0].value +'</div>'
				 + '	<div class="car-content">'
				 + '		<div class="car-double">'
				 + '			<div class="car-one">'
				 + '				<img src="../img/u653.png"/>'
				 + '				<div class="con-tit">'
				 + '					<p>'+ toStart +'</p>'
				 + '					<h4 class="startPoint">起点：'+ startPoint +'</h4>'
				 + '				</div>'
				 + '			</div>'
				 + '			<hr />'
				 + '			<div class="car-one">'
				 + '				<img src="../img/u655.png"/>'
				 + '				<div class="con-tit">'
				 + '					<p>'+ toEnd +'</p>'
				 + '					<h4 class="endPoint">终点：'+ endPoint +'</h4>'
				 + '				</div>'
				 + '			</div>'
				 + '		</div>'
				 + '		<div class="car-right">'
				 + '			<div class="tit-cc">'
				 + '				<span class="one">总里程</span><br/>'
				 + '				<span class="two">'+ parseFloat(totalMile).toFixed(1) +'km</span>'
				 + '			</div>'
				 + '			<img class="playTrack" src="../img/u659.png"/>'
				 + '		</div>'
				 + '	</div>'
				 + '</li>';	
	
	scrollDivUl.innerHTML = scrollLi;
	
	getReverseGeocode(data[0].offsetLon,data[0].offsetLat,startPoint);
	getReverseGeocode(data[leng-1].offsetLon,data[leng-1].offsetLat,endPoint);
	
	mui('.car-right').on('tap','.playTrack',function(){	
		mui.openWindow('track_play.html','track_play');
	});
}


var userPicker = new mui.PopPicker();                        //新建选择器对象
	userPicker.setData([{
		value: 2,
		text: "前两天"
	},{
		value: 3,
		text: "前三天"
	},{
		value: 4,
		text: "前四天"
	}]);
	
	
// 国标转百度坐标
function getCoordinates(lng, lat, myPoint){
	var point = new plus.maps.Point(lng, lat);
	plus.maps.Map.convertCoordinates(point,{coordType:"wgs84"},function(event){
		var point = event.coord;  // 转换后的坐标值
		var coordType = event.coordType;	// 转换后的坐标系类型
	//	console.log(JSON.stringify(point));
	    getReverseGeocode(point.longitude, point.latitude, myPoint);
	},function(e){
		alert("Failed:"+JSON.stringify(e));
	});
}
// 逆编码地理位置
function getReverseGeocode(lng, lat, myPoint){
	$.ajax({
        url: 'http://api.map.baidu.com/geocoder/v2/?ak=YpPYDb9u47Zvs6AElUqiTKtyZkpeEw20' + '&callback=renderReverse&location=' + lat + ',' + lng + '&output=json&pois=1&coordtype=bd09ll',
        type: 'post',
        dataType: 'jsonp',
        async: true,
        success: function (json) {
            if (json != null || json != undefined) {
                var address = json.result.formatted_address + ',' + json.result.sematic_description;
                if(myPoint == 0||myPoint == '0'){
			    	scrollDivUl.querySelector('.startPoint').innerText = address; //console.log(address);
			    }else if(myPoint == 1||myPoint == '1'){
			    	scrollDivUl.querySelector('.endPoint').innerText = address;
			    }          
            }
        }
    });
	
//	var point = new plus.maps.Point(lng,lat);
//	plus.maps.Map.reverseGeocode(point,{},function(event){
//	    //myPoint = event.address;  // 转换后的地理位置	 
//	    if(myPoint == 0||myPoint == '0'){
//	    	scrollDivUl.querySelector('.startPoint').innerText = event.address; console.log(event.address);
//	    }else if(myPoint == 1||myPoint == '1'){
//	    	scrollDivUl.querySelector('.endPoint').innerText = event.address;
//	    }	    
//	},function(e){
//		alert("Failed:"+JSON.stringify(e));
//	});
}
document.onclick = function(){
	searchDiv.style.display = 'none';
}
getCarList(0);
//	mui.each(document.querySelectorAll('.mui-scroll-wrapper .mui-scroll'), function(index, pullRefreshEl) {
//		mui(pullRefreshEl).pullToRefresh({
//			down: {
//				callback: function() {
//					var self = this;
//					
//					
//					setTimeout(function() {
//
//						console.log(6666);
//						self.endPullDownToRefresh();
//					}, 1000);
//				}
//			},
//			up: {
//				callback: function() {
//					var self = this;
//					setTimeout(function() {
//						
//						
//						console.log(8888);
//						self.endPullUpToRefresh();
//					}, 1000);
//				}
//			}
//		});
//	});